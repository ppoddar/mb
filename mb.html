<!DOCTYPE html5>
<html>
    <head>
        <meta charset="utf-8">
        <script src="./script/mb.js"></script>
        <link rel="icon" type="image/x-icon" href="../images/ganesha.ico">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href=" https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/blizer/jquery-ui.css">
<link rel="stylesheet" href="./css/mb.css">

    
    <script>
    $(function(){
            
            var mb = new Mahabharatha({root:'content', glossary:'glossary'})
            show_repository(mb.repo, $('#toc'))
            var chapter = mb.repo.find_chapter(localStorage.getItem('parva.index')||0, localStorage.getItem('chapter.index')||0)
            $("#toc").data('chapter', chapter)
            $('#toc').on('click', show_chapter)
            $('#toc').trigger('click')
        
        
           function show_repository(repo, $ul){
                for(var i = 0; i<repo.parvas.length; i++){
                    var $li = $('<li>')
                    var  p  = repo.parvas[i]
                        $li.text(p.label + ' ' + p.title)
                        var $chapters = $("<ul>")
                        $li.append($chapters)    
                    show_parva(p, $chapters)
                    $ul.append($li)
                }
           }

           function show_parva (parva, $ul){
            for (var i=0; i<parva.chapters.length;i++){
                var ch = parva.chapters[i]
                var $li = $('<li>')
                $li.text(`${ch.label} ${ch.title}`)
                $li.data('chapter', ch)
                $ul.append($li)   
                $li.data('chapter', ch) 
                $li.data('next', i+1)
                $li.on('click', function(e){
                    console.log('clicked ' + $(this).data('chapter').title)
                    show_chapter(e)
                    return false
                })
                //$li.on('click', this.alert.bind(this,'show chapter'))
                
            }
           }
           /*  displays title and content of a chapter.
           The chapter must be to data() of an HTML element. Then trigger() the element or call
           directly from the element's event handler function.
           */
           function show_chapter(e) {
            var chapter = $(e.target).data('chapter')
            console.log('showing chapter title=' + chapter.title + 'url=' + chapter.url + 'parva url=' + chapter.parva.url)
            localStorage.setItem('parva-index', chapter.parva.index)
            localStorage.setItem('chapter-index', chapter.index)
            $('#chapter > #title').text(chapter.label+' '+chapter.title)
            $('#chapter > #content').load(chapter.url, function(){
                $('#chapter > #title').get(0).scrollIntoView()
                $('.glossary').on('click', show_glossary)

                var next_chapter=mb.repo.next_chapter(chapter)
                
                $('#next-chapter').data('chapter', next_chapter)
                $('#next-chapter').on('click', function(e){
                    e.preventDefault()
                    e.stopPropagation()
                    console.log(`show next chapter ${next_chapter.parva.index}:${next_chapter.index}`)
                    show_chapter(e)
                    //off('click', '#next-chapter')
                    return false
                })
                var prev_chapter=mb.repo.prev_chapter(chapter)
                $('#prev-chapter').data('chapter', prev_chapter)
                $('#prev-chapter').on('click', function(e){
                    e.preventDefault()
                    e.stopPropagation()
                    console.log(`show prev chapter ${prev_chapter.parva.index}:${prev_chapter.index}`)
                    show_chapter(e)
                    //off('click', '#next-chapter')
                   
                    return false
                })
            }) // content load complete
        } // show chapter complete    
            
            
/* shows the glossary term in aside block 
*/
       function show_glossary(e) {
            var $el = $(e.target)
            var term = $el.text()
            var url = `glossary/${term}.html`
            console.log(`loading glossary term from [url]...`)
            $('aside')[0].scrollIntoView()
            $('aside').css('color', 'green')
            $.ajax({url:url,
                type:'HEAD',
                success: function(){
                    $('aside').load(url)
                },
                error: function(){
                    console.log(`no glossary term from [url]...`)
                    $('aside').text(`no information available on glossary item [${term}]`)
                    $('aside').css('color', 'red')
                }
            })  
        
    }})

    </script>
    </head>
    <body>
        <img src='images/ganesha.ico' width=24px height=24px id="home">
        <div class="w3-row">
            <div class="w3-col m4 l3">
                <ul style="list-style: none;"class="w3-small-text" id="toc"></ul>
                <aside></aside>
            </div>
            <div class="w3-col m8 l9">
                <div id="chapter">
                    <div id="title"></div>
                    <div id="content">
                    </div>
                    <div class="w3-bar">
                        <div class="w3-bar-item w3-button w3-text-black" id="prev-chapter">back</div>
                        <div class="w3-bar-item w3-button w3-text-blue" id="next-chapter">more...</div>
                        <span class="w3-bar-item w3-right" id="copyright">&copy;Pinaki Poddar 2024-30</span>
                    </div>
                </div>
            </div>

        </div>

        
        </div>
    </body>
</html>